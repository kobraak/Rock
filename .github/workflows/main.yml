name: AvicaRDP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350
    
    steps:
      - name: Direct Avica Setup
        id: avica_setup
        continue-on-error: true  # Prevents workflow from stopping if GoFile fails
        run: |
          Write-Host "ğŸš€ Starting Avica setup directly..." -ForegroundColor Green
          
          # Download files directly
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"
          
          # Install Python packages
          python.exe -m pip install requests pyautogui telegraph --quiet
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Set user password
          net user runneradmin TheDisa1a
          
          # Start Avica
          Write-Host "âš¡ Starting Avica..." -ForegroundColor Yellow
          python -c "import pyautogui as pag; pag.click(897, 64, duration=2)" 2>$null
          Start-Process "Avica_setup.exe"
          
          # Run setup script
          python setup.py
          
      - name: ğŸš¨ Emergency Backup Upload (If GoFile Failed)
        run: |
          Write-Host "Checking for screenshots to upload via Transfer.sh..." -ForegroundColor Cyan
          
          # Find any PNG or JPG files created by the setup script and upload them
          $files = Get-ChildItem -Path . -Include *.png, *.jpg -Recurse
          
          if ($files) {
              foreach ($file in $files) {
                  Write-Host "Uploading $($file.Name)..."
                  # Upload to transfer.sh
                  $response = curl.exe --upload-file "$($file.FullName)" "https://transfer.sh/$($file.Name)"
                  Write-Host " "
                  Write-Host "âœ… LINK: $response" -ForegroundColor Green
                  Write-Host " "
              }
          } else {
              Write-Host "âŒ No screenshots found. Setup might have failed before taking the picture." -ForegroundColor Red
          }

      - name: Setup System User
        run: |
          net user runneradmin TheDisa1a
          Write-Host "âœ… System user configured" -ForegroundColor Green
          
      - name: Show Connection Info
        run: |
          Write-Host "
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        AVICA RDP CONNECTION          â•‘  
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“‹ Instructions:
          â€¢ If GoFile failed above, look at the 'Emergency Backup Upload' step.
          â€¢ Copy the Transfer.sh link to see your ID/Password.
          
          â³ Keep alive active...
          " -ForegroundColor Cyan
          
      - name: Start Avica Service
        run: cmd /c show.bat
        
      - name: Keep Session Active
        run: |
          Write-Host "ğŸš€ Avica is running..." -ForegroundColor Yellow
          cmd /c loop.bat
