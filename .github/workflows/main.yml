name: Windows-RDP-Ngrok
on:
  workflow_dispatch: # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 # ‡ß¨ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶ö‡¶≤‡¶¨‡ßá

    steps:
      - name: Download Ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bPR9B2h3Y6e/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip

      - name: Authenticate Ngrok
        run: |
          .\ngrok.exe config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Enable Remote Desktop (RDP)
        run: |
          # RDP ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶Ö‡¶® ‡¶ï‡¶∞‡¶æ
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1

      - name: Create User Account
        run: |
          # ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ: runneradmin | ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°: TheDisa1a
          net user runneradmin TheDisa1a /add
          net localgroup administrators runneradmin /add

      - name: Start Ngrok Tunnel
        run: |
          # RDP ‡¶™‡ßã‡¶∞‡ßç‡¶ü (3389) ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü‡ßá ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
          Start-Process .\ngrok.exe -ArgumentList "tcp 3389 --region ap" 
          # ‡¶è‡¶ñ‡¶æ‡¶®‡ßá 'ap' ‡¶Æ‡¶æ‡¶®‡ßá ‡¶è‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∞‡¶ø‡¶ú‡¶ø‡¶Ø‡¶º‡¶®, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá 'us' ‡¶¨‡¶æ 'eu' ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§

      - name: Get RDP Connection Address
        run: |
          # ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏‡¶ü‡¶ø ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
          Start-Sleep -Seconds 10
          $ngrok_url = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels.public_url
          Write-Host "--------------------------------------------------------" -ForegroundColor Cyan
          Write-Host "‚úÖ RDP Connection Details:" -ForegroundColor Green
          Write-Host "IP Address : $ngrok_url" -ForegroundColor Yellow
          Write-Host "Username   : runneradmin" -ForegroundColor Yellow
          Write-Host "Password   : TheDisa1a" -ForegroundColor Yellow
          Write-Host "--------------------------------------------------------" -ForegroundColor Cyan
          Write-Host "‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶ø‡¶∏‡¶ø‡¶∞ 'Remote Desktop Connection' ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"

      - name: Keep Alive Loop
        run: |
          Write-Host "üöÄ RDP ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶∏‡ßá‡¶∂‡¶®‡¶ü‡¶ø ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§"
          # ‡¶∏‡ßá‡¶∂‡¶®‡¶ü‡¶ø ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡ßÅ‡¶™
          $i = 1
          while($i -le 360) {
            Write-Host "Active: $i minutes..."
            Start-Sleep -Seconds 60
            $i++
          }
